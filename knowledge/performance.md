# 性能优化和性能监控

## 白屏时间和首屏时间的计算

https://cloud.tencent.com/developer/article/1540176

白屏时间，是指页面开始请求，到页面刚开始显示内容的时间（一般认为，开始解析 body 就是页面开始解析的时间）

计算：

1. 刚开始展示的时间点，通过在 body 标签前写一个脚本获取时间
2. 刚开始请求的时间，可以用 window.performance.timing.navigationStart

白屏时间 = endTime - window.performance.timing.navigationStart

首屏时间，在不滚动屏幕的前提下，用户看到完整第一屏所花费的时间，需要全部加载完成

难点获取首屏线（也就是第一屏显示的最底部的 html，通过计算）？

1. 标记首屏标签模块
   - 首屏内不需要拉取数据，否则可能拿到首屏线获取时间的时候，首屏还是空白
   - 不考虑图片加载，只考虑首屏的主要模块
   - 首屏时间 = firstScreen - performance.timing.navigationStart
2. 统计首屏最慢图片加载时间
   - 逐个监听图片标签的 onload 事件，并收集到它们的加载事件最后比较得到加载时间的最大值
   - 首屏时间 = 加载最慢的首屏图片时间 - performance.timing.navigationStart

通过 window.performance 下的属性进行计算

window.performance

1. 方法：
   mark()
   now()

2. 属性：
   performance.timing，对象（PerformanceTiming）包含延迟相关的性能信息
   performance.navigation，对象表示在当前给定浏览上下文中网页导航的类型

3. PerformanceTiming
   PerformanceTiming.navigationStart 是表示从同一个浏览器上下文的上一个文档卸载结束时的时间搓

## 性能监控平台是如何捕获错误的

## 性能监控

## 性能优化

## 如何实现图片的懒加载，预加载

懒加载：
原理是暂时不设置图片的 src 属性，而是将图片的 url 隐藏起来，比如先写在 data-src 里面，等某些事件触发的时候（比如滚动到底部，点在再加载图片），再将真实的 url 放进入 src 属性里面，从而实现图片的延迟加载

具体的实现方式？

预加载：
指在一些需要展示大量图片的网站，实现图片的提前加载
常用的 2 种方式：

1. 隐藏在 css 的 background 的 url 属性里面
2. 通过 JS 的 Image 对象设置实例对象的 src 属性实现图片的预先加载

具体的实现方式？

## 静态资源加载和更新的策略

## 项目性能优化

https://juejin.im/post/5cc26dfef265da037b611738#heading-14

先从输入 url 到页面加载完成的过程，然后来分析优化方向

一 从输入 url 到页面加载完成步骤

1. DNS 解析，将域名解析成 IP 地址
2. TCP 三次握手
3. 发送 HTTP 请求
4. 服务器处理请求并返回 HTTP 报文
5. 浏览器解析渲染页面
6. 断开链接，TCP 四次挥手

二 分析优化方向

网络层优化：

1. DNS 解析，优化 DNS 查询
2. TCP 连接，优化 TCP 连接
3. HTTP 请求/响应，减少请求次数和减少单次请求所花费的时间

HTTP 请求优化：

1. 减少请求次数，如 资源（css，js，图片）的合并和压缩
2. 使用 CDN
3. 样式放在头部，脚本放在底部
4. 脚本优化加载，
   - 如动态加载
   - 异步加载
5. 按需加载，通过延迟相关资源的加载，从而提高页面的加载和响应速度
   - 虚拟代码加载
   - 惰性初始化
6. 合适使用缓存
   - 强缓存
   - 协商缓存

页面渲染时优化：

1. 客户端渲染
   - 服务端把渲染需要的静态文件发送给客户端，客户端进行加载渲染
2. SSR 渲染
   - 当用户请求时，由服务器把需要的组件或者页面渲染成 html 字符串，然后返回给客户端
   - 非常关键的性能问题：首屏加载过慢，SEO 搜索引擎问题

客户端渲染优化：

1. dom 优化
   - 减少 dom 的访问操作次数
   - 减少重绘和重排
   - 减少 dom 数量
2. css 优化
   - 减少 table 布局
   - 层级扁平
   - 减少使用通配符
   - 特定的选择器
   - 减少不必要的多余属性
   - 使用动画属性
3. js 优化
   - 减少闭包使用
   - 减少使用 iframe
   - 减少循环次数
   - 对象嵌套的越深，读取速度越慢
   - 使用 async 方式，defer 方式，动态创建 script 标签方式
4. 图片优化
   - 尽量不使用图片，使用 CSS3 代替
   - 雪碧图，SVG 图片，
   - 图片的懒加载和预先加载
   - 将图片转换成 base 格式
5. 缓存
   - gzip 压缩，cache-control，Etag

三 前端可以做的性能优化

1. 编码优化（指的是在代码编写时，通过一些最佳实践，提升代码的执行性能）
   - 数据读取
     通过作用域/原型链读取变量或方法时，需要更多的耗时，且越长越慢
   - 循环
     减少循环次数，减少遍历的数据量，完成目的后马上结束循环
     尽量避免使用 for-in 循环，因为会枚举原型对象，耗时大于普通循环
   - 条件流程性能
   - 减少 cookie 体积
   - dom 优化
     减少访问 dom 的次数
     减少重绘和回流
   - css 优化
     层级扁平
     特定的选择器
     减少使用通配符与属性选择器
     减少不必要的多余属性
     使用动画属性实现动画
   - html 优化
     减少 dom 数量，
     避免<img src="">空标签，
     减少使用 table 进行布局
2. 页面基础优化
   - 引入位置
   - 减少请求
   - 减少文件体积
   - 图片优化
   - 使用缓存
3. 首屏渲染优化
   - css/js 分割
   - 非关键性的文件斤可能的异步加载和懒加载，避免阻塞首页渲染
   - 控制好 web 字体
   - 合理利用 localStorage/server-worker 等存储方式进行数据与资源缓存
   - 分清轻重缓急
     重要的元素优先渲染
     视窗内的元素优先渲染
   - 服务端渲染
   - 优化用户感知

## 懒加载，预加载和异步加载的实现方式？
